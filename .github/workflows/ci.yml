name: CI

on:
  pull_request:
    branches: [ "main", "develop" ]
  push:
    branches:
      - "main"
      - "develop"
      - "release/**"
    tags:
      - "v*.*.*"

jobs:
  # =========================================================
  # Quality (tests/build)
  # =========================================================
  quality:
    name: quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --- Backend ---
      - name: Install deps (gateway)
        working-directory: services/gateway
        run: npm ci
      - name: Unit tests (gateway)
        working-directory: services/gateway
        run: npm test

      - name: Install deps (orders)
        working-directory: services/orders
        run: npm ci
      - name: Unit tests (orders)
        working-directory: services/orders
        run: npm test

      - name: Install deps (pricing)
        working-directory: services/pricing
        run: npm ci
      - name: Unit tests (pricing)
        working-directory: services/pricing
        run: npm test

      - name: Install deps (receipt)
        working-directory: services/receipt
        run: npm ci
      - name: Unit tests (receipt)
        working-directory: services/receipt
        run: npm test

      - name: Install deps (fx)
        working-directory: services/fx
        run: npm ci
      - name: Unit tests (fx)
        working-directory: services/fx
        run: npm test

      # --- Frontend ---
      - name: Build frontend (Vite)
        working-directory: services/frontend
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build
          else
            echo "Frontend aún no implementado"
          fi

  # =========================================================
  # Contracts (OpenAPI + Buf)
  # =========================================================
  contracts:
    name: contracts
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate OpenAPI (swagger-cli)
        run: |
          npm install -g swagger-cli
          swagger-cli validate contracts/openapi/quetzalship-gateway.yaml

      - name: Buf lint
        run: docker run --rm -v "${PWD}:/workspace" -w /workspace bufbuild/buf:latest lint

      - name: Buf generate
        run: docker run --rm -v "${PWD}:/workspace" -w /workspace bufbuild/buf:latest generate

  # =========================================================
  # Build & Push images to Docker Hub
  # - Only builds/pushes images that changed (on branches)
  # - On git tag vX.Y.Z builds/pushes ALL images (safe for release)
  # - Deterministic tagging (TAG_MAIN)
  # =========================================================
  docker-build:
    name: docker-build
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: [quality, contracts]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Decide if release tag (build all) ----
      - name: Decide build scope
        id: scope
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v*.*.* ]]; then
            echo "build_all=true" >> $GITHUB_OUTPUT
          else
            echo "build_all=false" >> $GITHUB_OUTPUT
          fi
          echo "build_all=$(cat <(echo))"

      # ---- Detect changed paths (only meaningful for branch pushes / PRs) ----
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          # For push events, compare against the previous commit
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            frontend:
              - 'services/frontend/**'
            gateway:
              - 'services/gateway/**'
              - 'contracts/**'
            orders:
              - 'services/orders/**'
              - 'contracts/**'
            fx:
              - 'services/fx/**'
              - 'contracts/**'
            pricing:
              - 'services/pricing/**'
              - 'contracts/**'
            receipt:
              - 'services/receipt/**'
              - 'contracts/**'

      # ---- Docker Hub auth (fail fast) ----
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify Docker Hub auth
        run: |
          docker info
          echo "Docker Hub login OK"

      # ---- TAGGING (deterministic, no ambiguity) ----
      # main -> main-<short_sha>
      # git tag vX.Y.Z -> vX.Y.Z
      # other pushes -> ci-<short_sha>
      - name: Compute Docker tag (TAG_MAIN)
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"

          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "TAG_MAIN=main-$SHORT_SHA" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == refs/tags/v*.*.* ]]; then
            REL_TAG="${GITHUB_REF#refs/tags/}"
            echo "TAG_MAIN=$REL_TAG" >> $GITHUB_ENV
          else
            echo "TAG_MAIN=ci-$SHORT_SHA" >> $GITHUB_ENV
          fi

          echo "Resolved TAG_MAIN=$TAG_MAIN"

      # =========================================================
      # BUILD (only changed OR build_all=true)
      # =========================================================
      - name: Build frontend image
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.frontend == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-frontend:$TAG_MAIN services/frontend

      - name: Build gateway image
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.gateway == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-gateway:$TAG_MAIN -f services/gateway/Dockerfile .

      - name: Build orders image
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.orders == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-orders:$TAG_MAIN -f services/orders/Dockerfile .

      - name: Build fx image
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.fx == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-fx:$TAG_MAIN -f services/fx/Dockerfile .

      - name: Build pricing image
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.pricing == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-pricing:$TAG_MAIN -f services/pricing/Dockerfile .

      - name: Build receipt image
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.receipt == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-receipt:$TAG_MAIN -f services/receipt/Dockerfile .

      # =========================================================
      # PUSH (only changed OR build_all=true)
      # =========================================================
      - name: Push frontend
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.frontend == 'true'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-frontend:$TAG_MAIN

      - name: Push gateway
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.gateway == 'true'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-gateway:$TAG_MAIN

      - name: Push orders
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.orders == 'true'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-orders:$TAG_MAIN

      - name: Push fx
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.fx == 'true'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-fx:$TAG_MAIN

      - name: Push pricing
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.pricing == 'true'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-pricing:$TAG_MAIN

      - name: Push receipt
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.receipt == 'true'
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-receipt:$TAG_MAIN

      # =========================================================
      # Evidence: tags exist per service (only for those pushed)
      # =========================================================
      - name: Evidence - tags exist in registry (frontend)
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.frontend == 'true'
        run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-frontend:$TAG_MAIN

      - name: Evidence - tags exist in registry (gateway)
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.gateway == 'true'
        run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-gateway:$TAG_MAIN

      - name: Evidence - tags exist in registry (orders)
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.orders == 'true'
        run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-orders:$TAG_MAIN

      - name: Evidence - tags exist in registry (fx)
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.fx == 'true'
        run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-fx:$TAG_MAIN

      - name: Evidence - tags exist in registry (pricing)
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.pricing == 'true'
        run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-pricing:$TAG_MAIN

      - name: Evidence - tags exist in registry (receipt)
        if: steps.scope.outputs.build_all == 'true' || steps.changes.outputs.receipt == 'true'
        run: docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-receipt:$TAG_MAIN

  # =========================================================
  # Deploy to GKE (same GCP_SA_KEY). Uses TAG_MAIN (no latest).
  # - Runs only on main or Git tag vX.Y.Z
  # - On main: deploy ONLY changed services
  # - On release tag: deploy ALL services
  # Namespace: sa
  # =========================================================
  deploy-gke:
    name: deploy-gke
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    needs: [docker-build]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide deploy scope
        id: scope
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v*.*.* ]]; then
            echo "deploy_all=true" >> $GITHUB_OUTPUT
          else
            echo "deploy_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changes (for main deploy)
        id: changes
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            frontend:
              - 'services/frontend/**'
            gateway:
              - 'services/gateway/**'
              - 'contracts/**'
            orders:
              - 'services/orders/**'
              - 'contracts/**'
            fx:
              - 'services/fx/**'
              - 'contracts/**'
            pricing:
              - 'services/pricing/**'
              - 'contracts/**'
            receipt:
              - 'services/receipt/**'
              - 'contracts/**'

      # ---- Auth GCP (fail fast) ----
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify GCP auth + access to GKE
        run: |
          gcloud auth list
          gcloud config list project
          gcloud container clusters list --project "${{ secrets.GCP_PROJECT_ID }}"

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # ---- Recompute TAG_MAIN for deploy (same deterministic rule) ----
      - name: Compute TAG_MAIN for deploy
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "TAG_MAIN=main-$SHORT_SHA" >> $GITHUB_ENV
          else
            REL_TAG="${GITHUB_REF#refs/tags/}"
            echo "TAG_MAIN=$REL_TAG" >> $GITHUB_ENV
          fi
          echo "Deploying TAG_MAIN=$TAG_MAIN"

      # ---- Deploy only what changed (or all on release tag) ----
      - name: Deploy frontend
        if: steps.scope.outputs.deploy_all == 'true' || steps.changes.outputs.frontend == 'true'
        run: |
          NS=sa
          kubectl -n $NS set image deployment/frontend frontend=${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-frontend:$TAG_MAIN
          kubectl -n $NS rollout status deployment/frontend

      - name: Deploy gateway
        if: steps.scope.outputs.deploy_all == 'true' || steps.changes.outputs.gateway == 'true'
        run: |
          NS=sa
          kubectl -n $NS set image deployment/gateway gateway=${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-gateway:$TAG_MAIN
          kubectl -n $NS rollout status deployment/gateway

      - name: Deploy orders
        if: steps.scope.outputs.deploy_all == 'true' || steps.changes.outputs.orders == 'true'
        run: |
          NS=sa
          kubectl -n $NS set image deployment/orders orders=${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-orders:$TAG_MAIN
          kubectl -n $NS rollout status deployment/orders

      - name: Deploy fx
        if: steps.scope.outputs.deploy_all == 'true' || steps.changes.outputs.fx == 'true'
        run: |
          NS=sa
          kubectl -n $NS set image deployment/fx fx=${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-fx:$TAG_MAIN
          kubectl -n $NS rollout status deployment/fx

      - name: Deploy pricing
        if: steps.scope.outputs.deploy_all == 'true' || steps.changes.outputs.pricing == 'true'
        run: |
          NS=sa
          kubectl -n $NS set image deployment/pricing pricing=${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-pricing:$TAG_MAIN
          kubectl -n $NS rollout status deployment/pricing

      - name: Deploy receipt
        if: steps.scope.outputs.deploy_all == 'true' || steps.changes.outputs.receipt == 'true'
        run: |
          NS=sa
          kubectl -n $NS set image deployment/receipt receipt=${{ secrets.DOCKERHUB_USERNAME }}/quetzalship-receipt:$TAG_MAIN
          kubectl -n $NS rollout status deployment/receipt

  post-deploy-tests:
    name: post-deploy-tests (smoke + locust)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    needs: [deploy-gke]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Auth GCP + creds del cluster (igual que deploy)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set namespace
        run: echo "NS=sa" >> $GITHUB_ENV

      # -----------------------------
      # 1) Descubrir IP pública del Ingress (automático)
      # -----------------------------
      - name: Get Ingress public IP
        run: |
          set -e
          IP=$(kubectl -n $NS get ingress quetzalship-ingress-api -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "$IP" ]; then
            echo "Ingress IP empty, printing ingress:"
            kubectl -n $NS get ingress quetzalship-ingress-api -o wide
            exit 1
          fi
          echo "INGRESS_IP=$IP" >> $GITHUB_ENV
          echo "Ingress IP: $IP"

      - name: Wait Ingress ready
        run: |
          set -e
          for i in {1..30}; do
            if curl -fsS "http://$INGRESS_IP/api/health" >/dev/null; then
              echo "Ingress ready!"
              exit 0
            fi
            echo "Waiting ingress... ($i/30)"
            sleep 5
          done
          echo "Ingress not ready in time"
          curl -i "http://$INGRESS_IP/api/health" || true
          exit 1

      # -----------------------------
      # 2) Smoke test (health + flujo mínimo)
      # -----------------------------
      - name: Smoke - health
        run: |
          set -e
          curl -fsS "http://$INGRESS_IP/api/health"

      - name: Smoke - create order
        id: create
        run: |
          set -e
          BODY='{
            "origin_zone":"ZONE_METRO",
            "destination_zone":"ZONE_INTERIOR",
            "service_type":"SERVICE_TYPE_STANDARD",
            "insurance_enabled":true,
            "packages":[{"weight_kg":1.2,"height_cm":30,"width_cm":20,"length_cm":40,"fragile":false,"declared_value_q":500}],
            "discount":{"type":"DISCOUNT_TYPE_PERCENT","value":10}
          }'
          RESP=$(curl -fsS -X POST "http://$INGRESS_IP/api/v1/orders" \
            -H "Content-Type: application/json" \
            -H "idempotency-key: 123e4567-e89b-12d3-a456-426614174000" \
            -d "$BODY")
          echo "$RESP"
          ORDER_ID=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['order_id'])")
          echo "ORDER_ID=$ORDER_ID" >> $GITHUB_ENV
          echo "Created ORDER_ID=$ORDER_ID"

      - name: Smoke - get order
        run: |
          set -e
          curl -fsS "http://$INGRESS_IP/api/v1/orders/$ORDER_ID"

      - name: Smoke - get receipt
        run: |
          set -e
          curl -fsS "http://$INGRESS_IP/api/v1/orders/$ORDER_ID/receipt"

      # (Opcional) Smoke FX
      - name: Smoke - fx rate
        run: |
          set -e
          curl -fsS "http://$INGRESS_IP/api/fx/rate?base=USD&quote=GTQ"

      # -----------------------------
      # 3) Locust Job dentro de GKE
      # -----------------------------
      - name: Apply locust manifests
        run: |
          set -e
          kubectl -n $NS delete job locust-run --ignore-not-found
          kubectl -n $NS apply -f k8s/loadtest/locust/

      - name: Wait locust job complete
        run: |
          set -e
          kubectl -n $NS wait --for=condition=complete job/locust-run --timeout=10m

      - name: Print locust logs
        if: always()
        run: |
          set +e
          kubectl -n $NS logs job/locust-run --tail=2000
          kubectl -n $NS get pods -l job-name=locust-run -o wide

      - name: Fail if locust job failed
        if: always()
        run: |
          set -e
          kubectl -n $NS wait --for=condition=failed job/locust-run --timeout=2s && exit 1 || exit 0

